Fixed some bugs and made performance improments